<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Androkumanda Ekran Yansıtma</title>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        #videoElement { width: 100%; height: 100%; object-fit: contain; position: absolute; z-index: 1; }
        #status-container { position: absolute; z-index: 10; top: 10%; left: 10%; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; max-width: 80%; }
        .log-line { color: #00FF00; font-family: monospace; font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div id="status-container"></div>
    <video id="videoElement" autoplay playsinline muted></video>

    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        const statusContainer = document.getElementById('status-container');
        const videoElement = document.getElementById('videoElement');

        function addLog(text) {
            const el = document.createElement('div');
            el.className = 'log-line';
            el.innerText = "> " + text;
            statusContainer.appendChild(el);
            console.log(text);
        }

        addLog("Androkumanda TV VP8 Modunda Bekliyor...");

        const CUSTOM_CHANNEL = 'urn:x-cast:com.user.androkumanda.webrtc';
        let peerConnection = null;

        context.addCustomMessageListener(CUSTOM_CHANNEL, async (customEvent) => {
            const message = customEvent.data;

            if (message.type === 'offer') {
                addLog("Teklif Geldi!");
                
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                peerConnection.ontrack = (event) => {
                    addLog("GÖRÜNTÜ GELDİ!");
                    if(event.streams && event.streams[0]) {
                        videoElement.srcObject = event.streams[0];
                    } else {
                        videoElement.srcObject = new MediaStream([event.track]);
                    }

                    videoElement.play().then(() => {
                        addLog("OYNATILIYOR!");
                        setTimeout(() => { statusContainer.style.display = 'none'; }, 4000);
                    }).catch(e => {
                        addLog("PLAY HATASI: " + e.message);
                    });
                };

                peerConnection.oniceconnectionstatechange = () => {
                    if (peerConnection) {
                         addLog("AĞ DURUMU: " + peerConnection.iceConnectionState);
                    }
                };

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        context.sendCustomMessage(CUSTOM_CHANNEL, customEvent.senderId, {
                            type: 'candidate', candidate: event.candidate
                        });
                    }
                };

                // TELEFONUN GÖNDERDİĞİ KODEK LİSTESİNDEN SADECE VP8'İ ZORLA (Hata önleyici)
                let sdp = message.offer.sdp;
                // TV'yi kitleyen donanımsal H264 kodeğini tamamen reddet! 
                // Bu kod satırı, Androkumanda'nın Mi Box'ta saniyesinde kopmasını ENGELLEYECEKTİR:
                message.offer.sdp = sdp.replace(/a=fmtp:(.*)apt=(.*)\r\n/g, ''); 

                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                context.sendCustomMessage(CUSTOM_CHANNEL, customEvent.senderId, {
                    type: 'answer', answer: answer
                });
            } 
            else if (message.type === 'candidate' && peerConnection) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
            else if (message.type === 'stop') {
                if (peerConnection) peerConnection.close();
                peerConnection = null;
                videoElement.srcObject = null;
                addLog("Yansıtma Kapandı.");
                statusContainer.style.display = 'block';
            }
        });

        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true;
        context.start(options);
    </script>
</body>
</html>
